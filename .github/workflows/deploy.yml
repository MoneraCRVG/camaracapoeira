name: Deploy Fullstack App

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    # 1. We MUST specify the environment to access variables defined in 'VPS'
    environment: VPS 
    runs-on: ubuntu-latest
    container:
      image: rust:latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install System Dependencies
        run: |
          apt-get update
          apt-get install -y openssh-client curl tar git pkg-config libssl-dev

      - name: Install Rust WebAssembly Target
        run: rustup target add wasm32-unknown-unknown

      - name: Install cargo-leptos
        # Installs from source (no cache as requested)
        run: cargo install cargo-leptos

      - name: Build Application
        run: cargo leptos build --release

      - name: Prepare Artifact
        run: |
          mkdir -p deploy_staging
          # Copy the compiled binary (name defaults to package name in Cargo.toml)
          cp target/release/camaracapoeira deploy_staging/
          # Copy the 'site' folder containing WASM, JS, CSS, and assets
          cp -r target/site deploy_staging/site
          # Create the tarball with a flat structure (binary and site folder at root)
          tar -czf artifact.tar.gz -C deploy_staging .

      - name: Deploy to VPS
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          # These pull from the 'VPS' environment variables
          SSH_HOST: ${{ vars.SSH_HOST }}
          SSH_USER: ${{ vars.SSH_USER }}
        run: |
          # Debug: Print variable availability (will print empty if not found)
          echo "Deploying to Host: $SSH_HOST as User: $SSH_USER"
          
          if [ -z "$SSH_HOST" ] || [ -z "$SSH_USER" ]; then
            echo "Error: SSH_HOST or SSH_USER is empty. Check Settings -> Environments -> VPS -> Variables."
            exit 1
          fi

          # 1. Configure SSH
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # 2. Upload Artifact to 'incoming' folder
          # -o StrictHostKeyChecking=no skips the 'Host key verification failed' error
          scp -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa artifact.tar.gz $SSH_USER@$SSH_HOST:/srv/www.camaracapoeira.org.br/incoming/

          # 3. Trigger the deployment script
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa $SSH_USER@$SSH_HOST "sudo /usr/local/bin/deploys/web_camara_capoeira_org_br_fullstack.bash"